<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Komikindo Viewer</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:sans-serif;}
body{background:#f4f4f9;padding:20px;}
h1{text-align:center;margin-bottom:20px;color:#333;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,0.1);cursor:pointer;transition:0.2s;display:flex;flex-direction:column;}
.card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,0.15);}
.card img{width:100%;height:280px;object-fit:cover;}
.card-body{padding:15px;display:flex;flex-direction:column;gap:8px;}
.card-title{font-size:18px;font-weight:bold;color:#222;}
.card-type{font-size:14px;color:#888;}
.spinner{width:50px;height:50px;border:6px solid #f3f3f3;border-top:6px solid #1e90ff;border-radius:50%;animation:spin 1s linear infinite;margin:100px auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.error-message{text-align:center;font-size:18px;color:#ff4d4d;padding:50px 20px;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;padding:20px;z-index:9999;}
.modal-content{background:#fff;border-radius:12px;max-width:90%;width:100%;max-height:90vh;overflow-y:auto;padding:20px;position:relative;}
.modal-close{position:absolute;top:15px;right:15px;font-size:24px;cursor:pointer;}
.modal img{width:100%;max-height:400px;object-fit:cover;border-radius:8px;margin-bottom:15px;}
.modal h2{margin-bottom:10px;}
.modal p{margin-bottom:10px;line-height:1.4;}
.modal a{color:#1e90ff;text-decoration:none;}
.modal a:hover{text-decoration:underline;}
.chapter-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;}
.chapter-grid img{width:100%;border-radius:8px;}
@media(max-width:900px){.grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr));}}
@media(max-width:600px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<h1>Komikindo Popular</h1>
<div id="komikGrid"><div class="spinner"></div></div>

<!-- Modal Detail Komik -->
<div class="modal" id="detailModal">
  <div class="modal-content" id="modalContent">
    <span class="modal-close" id="modalClose">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Modal Chapter Viewer -->
<div class="modal" id="chapterModal">
  <div class="modal-content" id="chapterContent">
    <span class="modal-close" id="chapterClose">&times;</span>
    <div id="chapterBody"></div>
  </div>
</div>

<script>
const komikGrid = document.getElementById("komikGrid");
const detailModal = document.getElementById("detailModal");
const modalBody = document.getElementById("modalBody");
const modalClose = document.getElementById("modalClose");
const chapterModal = document.getElementById("chapterModal");
const chapterBody = document.getElementById("chapterBody");
const chapterClose = document.getElementById("chapterClose");

// Fetch populer
async function fetchKomik() {
  try {
    const res = await fetch("/api/komik");
    const data = await res.json();
    if(data.success && data.result.length>0){
      komikGrid.innerHTML="";
      const container=document.createElement("div");
      container.className="grid";
      komikGrid.appendChild(container);
      data.result.forEach(item=>{
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`<img src="${item.img}" alt="${item.title}"><div class="card-body"><div class="card-title">${item.title}</div><div class="card-type">${item.type}</div></div>`;
        card.addEventListener("click",()=>showDetail(item.url));
        container.appendChild(card);
      });
    }else{
      komikGrid.innerHTML='<div class="error-message">Gagal load data, coba lagi nanti.</div>';
    }
  }catch(err){
    console.error(err);
    komikGrid.innerHTML='<div class="error-message">Gagal load data, coba lagi nanti.</div>';
  }
}

// Detail komik
async function showDetail(url){
  detailModal.style.display="flex";
  modalBody.innerHTML='<div class="spinner"></div>';
  try{
    const res=await fetch(`/api/komik-detail?url=${encodeURIComponent(url)}`);
    const data=await res.json();
    if(data.success && data.result.length>0){
      const k=data.result[0];
      modalBody.innerHTML=`
        <img src="${k.cover}" alt="${k.title}">
        <h2>${k.title} (${k.type})</h2>
        <p><strong>Status:</strong> ${k.status} | <strong>Score:</strong> ${k.score}</p>
        <p><strong>Author:</strong> ${k.author.map(a=>a.name).join(", ")}</p>
        <p><strong>Genre:</strong> ${k.genre.map(g=>`<a href="${g.link}" target="_blank">${g.name}</a>`).join(", ")}</p>
        <p><strong>Synopsis:</strong> ${k.synopsis}</p>
        <h3>Chapters</h3>
        <div class="chapter-grid">
          ${k.data.map(ch=>`<div style="cursor:pointer;"><img src="${k.img}" alt="${ch.chapter}"><p style="text-align:center;font-size:14px;">${ch.chapter}</p></div>`).join("")}
        </div>
      `;
      // Tambah click chapter
      k.data.forEach((ch,i)=>{
        const div=modalBody.querySelectorAll(".chapter-grid div")[i];
        div.addEventListener("click",()=>showChapter(ch.url));
      });
    }else{
      modalBody.innerHTML='<div class="error-message">Gagal load detail komik.</div>';
    }
  }catch(err){
    console.error(err);
    modalBody.innerHTML='<div class="error-message">Gagal load detail komik.</div>';
  }
}

// Chapter viewer
async function showChapter(url){
  chapterModal.style.display="flex";
  chapterBody.innerHTML='<div class="spinner"></div>';
  try{
    const res=await fetch(`/api/komik-image?url=${encodeURIComponent(url)}`);
    const data=await res.json();
    if(data.success){
      const imgArr=data.result.image;
      chapterBody.innerHTML=imgArr.map(img=>`<img src="${img}" loading="lazy">`).join("");
    }else{
      chapterBody.innerHTML='<div class="error-message">Gagal load gambar chapter.</div>';
    }
  }catch(err){
    console.error(err);
    chapterBody.innerHTML='<div class="error-message">Gagal load gambar chapter.</div>';
  }
}

// Close modals
modalClose.addEventListener("click",()=>detailModal.style.display="none");
chapterClose.addEventListener("click",()=>chapterModal.style.display="none");
window.addEventListener("click",e=>{if(e.target===detailModal)detailModal.style.display="none";if(e.target===chapterModal)chapterModal.style.display="none";});

fetchKomik();
</script>
</body>
</html>
