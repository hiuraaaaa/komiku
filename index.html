<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Komikindo Popular & Detail</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f4f4f9; padding: 20px; }

    h1 { text-align: center; margin-bottom: 20px; color: #333; }

    /* Grid Card */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .card img { width: 100%; height: 280px; object-fit: cover; }
    .card-body { padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    .card-title { font-size: 18px; font-weight: bold; color: #222; text-decoration: none; }
    .card-type { font-size: 14px; color: #888; }

    /* Spinner */
    .spinner { width: 50px; height: 50px; border: 6px solid #f3f3f3; border-top: 6px solid #1e90ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 100px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Error */
    .error-message { text-align: center; font-size: 18px; color: #ff4d4d; padding: 50px 20px; }

    /* Modal */
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; padding: 20px; z-index: 9999; }
    .modal-content { background: #fff; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 20px; position: relative; }
    .modal-close { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; }
    .modal img { width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; }
    .modal h2 { margin-bottom: 10px; }
    .modal p { margin-bottom: 10px; line-height: 1.4; }
    .modal a { color: #1e90ff; text-decoration: none; }
    .modal a:hover { text-decoration: underline; }

    @media (max-width: 900px) { .grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Komikindo Popular</h1>
  <div id="komikGrid">
    <div class="spinner"></div>
  </div>

  <!-- Modal Detail -->
  <div class="modal" id="detailModal">
    <div class="modal-content" id="modalContent">
      <span class="modal-close" id="modalClose">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const popularURL = "/api/komik"; // pakai serverless function Vercel
    const modal = document.getElementById('detailModal');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');

    async function fetchKomik() {
      const grid = document.getElementById("komikGrid");
      try {
        const res = await fetch(popularURL);
        const data = await res.json();

        if(data.success && data.result.length > 0) {
          grid.innerHTML = "";
          const container = document.createElement("div");
          container.className = "grid";
          grid.appendChild(container);

          data.result.forEach(item => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <img src="${item.img}" alt="${item.title}">
              <div class="card-body">
                <div class="card-title">${item.title}</div>
                <div class="card-type">${item.type}</div>
              </div>
            `;
            card.addEventListener("click", () => showDetail(item.url));
            container.appendChild(card);
          });
        } else {
          grid.innerHTML = '<div class="error-message">Gagal load data, coba lagi nanti.</div>';
        }
      } catch (err) {
        grid.innerHTML = '<div class="error-message">Gagal load data, coba lagi nanti.</div>';
        console.error(err);
      }
    }

    async function showDetail(url) {
      modal.style.display = "flex";
      modalBody.innerHTML = '<div class="spinner"></div>';
      try {
        const res = await fetch(`/api/komik-detail?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        if(data.success && data.result.length > 0) {
          const komik = data.result[0];
          modalBody.innerHTML = `
            <img src="${komik.cover}" alt="${komik.title}">
            <h2>${komik.title} (${komik.type})</h2>
            <p><strong>Status:</strong> ${komik.status} | <strong>Score:</strong> ${komik.score}</p>
            <p><strong>Author:</strong> ${komik.author.map(a=>a.name).join(", ")}</p>
            <p><strong>Genre:</strong> ${komik.genre.map(g=>`<a href="${g.link}" target="_blank">${g.name}</a>`).join(", ")}</p>
            <p><strong>Demographic:</strong> ${komik.demographic.map(d=>`<a href="${d.link}" target="_blank">${d.name}</a>`).join(", ")}</p>
            <p><strong>Theme:</strong> ${komik.theme.map(t=>`<a href="${t.link}" target="_blank">${t.name}</a>`).join(", ")}</p>
            <p><strong>Synopsis:</strong> ${komik.synopsis}</p>
            <h3>Chapters</h3>
            <ul>
              ${komik.data.map(ch => `<li><a href="${ch.url}" target="_blank">${ch.chapter}</a> | <a href="${ch.download}" target="_blank">Download</a></li>`).join("")}
            </ul>
          `;
        } else {
          modalBody.innerHTML = '<div class="error-message">Gagal load detail komik.</div>';
        }
      } catch (err) {
        modalBody.innerHTML = '<div class="error-message">Gagal load detail komik.</div>';
        console.error(err);
      }
    }

    modalClose.addEventListener("click", () => modal.style.display = "none");
    window.addEventListener("click", e => { if(e.target === modal) modal.style.display = "none"; });

    fetchKomik();
  </script>
</body>
</html>
